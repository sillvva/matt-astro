---
import { Code } from "astro:components";
import { getLanguage, languages, getCodeCollection } from "$/util";
import AnimatedButton from "../animated-button.astro";

const codeCollection = await getCodeCollection();

type Props = {
	wrap?: boolean;
} & ({
	type: "code";
  code: string;
	lang: (typeof languages)[number];
} | {
	type: "collection";
	id: keyof typeof codeCollection;
})

const { wrap = false, ...rest } = Astro.props;

let code = "";
let lang: (typeof languages)[number] = "plaintext";
let playground = "";
let source = "";

if ("code" in rest) {
	code = rest.code;
	lang = rest.lang || "plaintext";
} else {
	code = codeCollection[rest.id].body.trim();
	lang = getLanguage(code.match(/\`\`\`(.*?)\n/)?.[1]);
	code = code.replace(/^\`\`\`(.*?)\n/, "").replace(/\`\`\`$/g, "");
	playground = codeCollection[rest.id].playground || "";
	source = codeCollection[rest.id].source || ""
}
---

<script>
	function copyBlock(el: Element) {
		navigator.clipboard.writeText(el.parentNode?.parentNode?.querySelector("pre")?.innerText || "");
		document.querySelectorAll(".copy, .combined-copy").forEach((btn) => {
			btn.innerHTML = "Copy";
			btn.classList.add("bg-gray-700");
			btn.classList.remove("bg-green-700");
		});
		el.innerHTML = "Copied";
		el.classList.remove("bg-gray-700");
		el.classList.add("bg-green-700");
	}

	document.addEventListener("astro:page-load", () => {
		document.querySelectorAll("article > section > .pre-block .copy").forEach((btn) => {
			btn.addEventListener("click", () => copyBlock(btn));
		});
	});
</script>

{(playground || source) &&
	<div class="button-row">
		{playground &&
			<AnimatedButton link={playground} target="_blank" itemClasses={["button3 border border-dotted border-secondary text-secondary"]}>
				Playground
			</AnimatedButton>
		}
		{source &&
			<AnimatedButton link={source} target="_blank" itemClasses={["button3 border border-dotted border-secondary text-secondary"]}>
				Source
			</AnimatedButton>
		}
	</div>
}

<div
	class="pre-block relative mb-4 mt-2 rounded-md border border-base-100 text-base-content"
>
	<div
		class="flex items-center justify-between rounded-t border-b border-base-100 bg-neutral-800 p-2 text-sm"
	>
		<div class="flex space-x-1">
			<div class="h-2 w-2 rounded-full bg-gray-500"></div>
			<div class="h-2 w-2 rounded-full bg-gray-500"></div>
			<div class="h-2 w-2 rounded-full bg-gray-500"></div>
		</div>
		<button class="copy rounded-md bg-gray-700 px-2 py-1 text-sm text-white" type="button">Copy</button>
	</div>
  <Code code={code.trim()} {lang} theme="aurora-x" {wrap} class="mt-0 rounded-t-none text-xs" />
</div>