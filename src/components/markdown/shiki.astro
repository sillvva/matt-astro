---
import { cn } from "$/util";
import theme from "$/theme.json";
import { Code } from "astro:components";
import { type BundledLanguage } from "shiki";

interface Props {
	code: string;
	lang?: BundledLanguage;
	class?: string;
	wrap?: boolean;
}

const { code, lang, wrap } = Astro.props;
---

<script>
	function copyBlock(el: Element) {
		navigator.clipboard.writeText(el.parentNode?.parentNode?.querySelector("pre")?.innerText || "");
		document.querySelectorAll(".copy").forEach((btn) => {
			btn.innerHTML = "Copy";
			btn.classList.add("bg-gray-700");
			btn.classList.remove("bg-green-700");
		});
		el.innerHTML = "Copied";
		el.classList.remove("bg-gray-700");
		el.classList.add("bg-green-700");
	}

	document.addEventListener("astro:page-load", () => {
		document.querySelectorAll("article .code-block.shiki").forEach((block) => {
			const btn = block.querySelector(".copy");
			if (btn) btn.addEventListener("click", () => copyBlock(btn));
		});
	});
</script>

<div class="code-block shiki group">
	<nav class="group-[.tabbed-code]:py-0">
		<div class="hidden space-x-1 md:flex">
			<div class="h-2 w-2 rounded-full bg-gray-500"></div>
			<div class="h-2 w-2 rounded-full bg-gray-500"></div>
			<div class="h-2 w-2 rounded-full bg-gray-500"></div>
		</div>
		<label class="code-tab group-[.tabbed-code]:block md:ml-3"> </label>
		<div class="flex-1"></div>
		<button class="copy" type="button">Copy</button>
	</nav>
	<span class="lang">{lang}</span>
	<div class="max-h-[20rem] overflow-y-auto md:max-h-[40rem]">
		<Code
			{code}
			{lang}
			{wrap}
			theme={{
				name: theme.name,
				settings: theme.tokenColors
			}}
			class={cn(Astro.props.class, "group my-2")}
		/>
	</div>
</div>
