---
import type { ImageOutputFormat } from "astro";
import { getImage, type ImgAttributes } from "astro:assets";

type Unit = "px" | "em" | "rem";
type Size = `${number}${Unit}`;
type MinMediaQuery = `(min-width: ${Size})`;
type MaxMediaQuery = `(max-width: ${Size})`;
type OrientationMediaQuery = "(orientation: portrait)" | "(orientation: landscape)";
type MediaQueries = MinMediaQuery | MaxMediaQuery | OrientationMediaQuery;

type Props = Omit<ImgAttributes, "sizes"> & {
	src: ImageMetadata;
	format?: ImageOutputFormat;
	sizes: number[];
	media?: (
		| `${MediaQueries} ${Size}`
		| `(${MinMediaQuery} and ${MaxMediaQuery}) ${Size}`
		| `(${MaxMediaQuery} or ${MinMediaQuery}) ${Size}`
		| Size
	)[];
};

const { src, sizes, format, alt, id, media } = Astro.props;
const className = Astro.props.class;

if (!sizes.length) throw new Error("No sizes provided");
if (sizes.length !== media?.length) throw new Error("Sizes and media queries must be the same length");

const imgSrcSet = await Promise.allSettled(
	sizes.map(async (size) => {
		const image = await getImage({ src, width: size, format });
		return { src: `${image.src} ${size}w`, size };
	})
);

const srcSet = imgSrcSet.map((result) => (result.status === "fulfilled" ? result.value.src : "")).filter(Boolean);
const imgSrc = await getImage({ src, width: Math.min(...sizes), format });
---

<img srcset={srcSet.join(", ")} sizes={media?.join(", ")} {id} {alt} src={imgSrc.src} class={className} loading="lazy" />
